<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/navbar_style.css" />
    <link rel="stylesheet" href="../css/footer_style.css" />
    <link rel="stylesheet" href="../css/authdashboard_style.css" />
    <link rel="stylesheet" href="../css/authnewslist_style.css" />
    <link rel="stylesheet" href="../css/authsidebar_style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body>
    <!-- Navbar di paling atas -->
    <header id="navbar"></header>

    <!-- Konten utama dengan sidebar dan main content -->
    <div class="content-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="profile">
                <div class="avatar">
                    <img id="profileAvatar" src="" alt="Profile Picture">
                </div>
                <div class="name-role">
                    <strong id="userName">Nama</strong>
                    <span id="userRole">Role</span>
                </div>
            </div>
            <div class="side-menu">
                <!-- Menu items will be generated by JavaScript -->
            </div>
        </aside>

        <!-- Konten utama -->
        <main class="main-content">
            <h1>DASHBOARD</h1>

            <div id="admin-dashboard" style="display: none;">
                <!-- USER SECTION -->
                <section class="dashboard-section">
                    <h2>User</h2>
                    <div class="dashboard-row">

                        <div class="card bg-blue">
                            <p>User Aktif</p>
                            <h4 id="activeUser">0</h4>
                        </div>
                        <div class="card bg-red">
                            <p>User Tidak Aktif</p>
                            <h4 id="inactiveUser">0</h4>
                        </div>
                        <div class="card bg-gray">
                            <p>Jurnalis</p>
                            <h4 id="journalists">0</h4>
                        </div>
                        <div class="card bg-yellow">
                            <p>Pembaca</p>
                            <h4 id="readers">0</h4>
                        </div>
                        <div class="card bg-green">
                            <p>Jumlah Total User</p>
                            <h2 id="totalUser">0</h2>
                        </div>
                    </div>
                </section>

                <!-- BERITA SECTION -->
                <section class="dashboard-section">
                    <h2>Berita</h2>
                    <div class="dashboard-row">
                        <div class="card bg-gray">
                            <p>DRAFT</p>
                            <h4 id="newsDraft">0</h4>
                        </div>
                        <div class="card bg-yellow">
                            <p>MENUNGGU VERIFIKASI</p>
                            <h4 id="newsPending">0</h4>
                        </div>
                        <div class="card bg-green">
                            <p>DIPUBLIKASIKAN</p>
                            <h4 id="newsPublished">0</h4>
                        </div>
                        <div class="card bg-red">
                            <p>DITOLAK</p>
                            <h4 id="newsRejected">0</h4>
                        </div>
                        <div class="card bg-blue">
                            <p>Jumlah Total Berita</p>
                            <h2 id="totalNews">0</h2>
                        </div>
                    </div>
                </section>

                <!-- KATEGORI SECTION -->
                <section class="dashboard-section">
                    <div class="section-header">
                        <h2>Kategori</h2>
                        <button class="btn-primary" onclick="window.location.href='tambah_kategori.html'">
                            Tambah Kategori
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Nama Kategori</th>
                                    <th>Deskripsi</th>
                                    <th>Jumlah Berita</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="categoryTableBody">
                                <tr>
                                    <td colspan="5" class="loading">Memuat data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="journalist-dashboard" style="display: none;">
                <section class="dashboard-section">
                    <h2>Berita</h2>
                    <div class="dashboard-row">
                        <div class="card bg-gray">
                            <p>DRAFT</p>
                            <h4 id="myNewsDraft">0</h4>
                        </div>
                        <div class="card bg-yellow">
                            <p>MENUNGGU VERIFIKASI</p>
                            <h4 id="myNewsPending">0</h4>
                        </div>
                        <div class="card bg-green">
                            <p>DIPUBLIKASIKAN</p>
                            <h4 id="myNewsPublished">0</h4>
                        </div>
                        <div class="card bg-red">
                            <p>DITOLAK</p>
                            <h4 id="myNewsRejected">0</h4>
                        </div>
                        <div class="card bg-blue">
                            <p>Jumlah Berita Saya</p>
                            <h2 id="myTotalNews">0</h2>
                        </div>
                    </div>
                </section>
            </div>


            <div id="loading-message" class="loading-container">
                <p>Memuat dashboard...</p>
            </div>
            <div id="error-message" class="error-container" style="display: none;">
                <p>Gagal memuat data dashboard. <button onclick="loadDashboardData()">Coba lagi</button></p>
            </div>
        </main>
    </div>

    <!-- Footer di paling bawah -->
    <footer id="footer"></footer>
    <script src="../src/utils.js"></script>
    <script src="../src/components/navbar.js"></script>
    <script src="../src/components/footer.js"></script>
    <script>
        // Fungsi untuk decode token JWT
        function decodeToken(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(
                    atob(base64)
                        .split('')
                        .map(function (c) {
                            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                        })
                        .join('')
                );
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error("Invalid token", error);
                return null;
            }
        }

        // Fungsi untuk generate menu sidebar berdasarkan role
        function generateSideMenu(roleId) {
            let menuItems = '';

            // Common items for both roles
            menuItems += '<a href="auth_dashboard.html" class="active">Dashboard</a>';
            menuItems += '<a href="news_form.html">Tulis Berita</a>';
            menuItems += '<a href="auth_newslist.html">Daftar Berita</a>';

            // Admin-specific items
            if (roleId === 1) {
                menuItems += '<a href="daftar_user.html">Daftar User</a>';
                menuItems += '<a href="tambah_user.html">Tambah User</a>';
            }

            // Common items for both roles
            menuItems += '<a href="edit_profil.html">Edit Profil</a>';
            menuItems += '<a href="#" onclick="handleLogout()">Logout</a>';

            return menuItems;
        }

        // Fungsi untuk memuat data dashboard
async function loadDashboardData(user) {
    const token = sessionStorage.getItem("token");
    if (!token) {
        window.location.href = "../pages/login.html";
        return;
    }

    try {
        document.getElementById("loading-message").style.display = "block";
        document.getElementById("error-message").style.display = "none";

        // Ambil semua berita
        const newsRes = await fetch(`${BASE_URL}/api/news/all`, {
            headers: { Authorization: `Bearer ${token}` }
        });

        if (!newsRes.ok) throw new Error("Gagal memuat data berita");

        const newsData = await newsRes.json();
        const news = newsData.data || [];

        const roleId = user.roleId;

        if (roleId === 1) {
            // ADMIN
            const [userRes, categoryRes] = await Promise.all([
                fetch(`${BASE_URL}/api/user/admin/all-user`, {
                    headers: { Authorization: `Bearer ${token}` }
                }),
                fetch(`${BASE_URL}/api/categories`, {
                    headers: { Authorization: `Bearer ${token}` }
                })
            ]);

            if (!userRes.ok || !categoryRes.ok) throw new Error("Gagal memuat data pengguna/kategori");

            const [userData, categoryData] = await Promise.all([
                userRes.json(),
                categoryRes.json()
            ]);

            const users = userData.data || [];
            const categories = categoryData.data || [];

            // Populate user data
            document.getElementById("totalUser").textContent = users.length;
            document.getElementById("activeUser").textContent = users.filter(u => u.status === 'ACTIVE').length;
            document.getElementById("inactiveUser").textContent = users.filter(u => u.status === 'INACTIVE').length;
            document.getElementById("journalists").textContent = users.filter(u => u.role?.name === 'Jurnalis').length;
            document.getElementById("readers").textContent = users.filter(u => u.role?.name === 'Pembaca').length;

            // Populate news data
            document.getElementById("totalNews").textContent = news.length;
            document.getElementById("newsDraft").textContent = news.filter(n => n.status === 'DRAFT').length;
            document.getElementById("newsPending").textContent = news.filter(n => n.status === 'MENUNGGU VERIFIKASI').length;
            document.getElementById("newsPublished").textContent = news.filter(n => n.status === 'DIPUBLIKASIKAN').length;
            document.getElementById("newsRejected").textContent = news.filter(n => n.status === 'DITOLAK').length;

            // Populate category table
            const tbody = document.getElementById("categoryTableBody");
            if (categories.length > 0) {
                tbody.innerHTML = categories.map((cat, idx) => `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${cat.name}</td>
                        <td>${cat.description || '-'}</td>
                        <td>${news.filter(n => n.categoryId === cat.id).length}</td>
                        <td class="actions">
                            <button class="edit-btn" onclick="editCategory(${cat.id})">Edit</button>
                            <button class="delete-btn" onclick="deleteCategory(${cat.id})">Hapus</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5">Tidak ada data kategori</td></tr>';
            }

            document.getElementById("admin-dashboard").style.display = "block";
        } else if (roleId === 2) {
            // JURNALIS
            const myNews = news.filter(n => n.authorId === user.id);

            document.getElementById("myTotalNews").textContent = myNews.length;
            document.getElementById("myNewsDraft").textContent = myNews.filter(n => n.status === 'DRAFT').length;
            document.getElementById("myNewsPending").textContent = myNews.filter(n => n.status === 'MENUNGGU VERIFIKASI').length;
            document.getElementById("myNewsPublished").textContent = myNews.filter(n => n.status === 'DIPUBLIKASIKAN').length;
            document.getElementById("myNewsRejected").textContent = myNews.filter(n => n.status === 'DITOLAK').length;

            document.getElementById("journalist-dashboard").style.display = "block";
        }

        document.getElementById("loading-message").style.display = "none";

    } catch (err) {
        console.error("Error loading dashboard data:", err);
        document.getElementById("loading-message").style.display = "none";
        document.getElementById("error-message").style.display = "block";
        document.getElementById("admin-dashboard").style.display = "none";
        document.getElementById("journalist-dashboard").style.display = "none";
    }
}


        // Fungsi untuk logout
        function handleLogout() {
            if (confirm("Apakah Anda yakin ingin logout?")) {
                sessionStorage.removeItem("token");
                sessionStorage.removeItem("userData");
                window.location.href = "../pages/login.html";
            }
        }

        // Fungsi untuk edit kategori
        function editCategory(id) {
            window.location.href = `edit_kategori.html?id=${id}`;
        }

        // Fungsi untuk hapus kategori
        async function deleteCategory(id) {
            if (!confirm("Apakah Anda yakin ingin menghapus kategori ini?")) return;

            try {
                const token = sessionStorage.getItem("token");
                const response = await fetch(`${BASE_URL}/api/categories/${id}`, {
                    method: "DELETE",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error("Gagal menghapus kategori");
                }

                const result = await response.json();
                if (result.status === "success") {
                    alert("Kategori berhasil dihapus");
                    loadDashboardData();
                } else {
                    throw new Error(result.message || "Gagal menghapus kategori");
                }
            } catch (error) {
                console.error("Error deleting category:", error);
                alert(`Gagal menghapus kategori: ${error.message}`);
            }
        }

        // Inisialisasi saat DOM siap
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                // Load navbar dan footer
                const [navbarHTML, footerHTML] = await Promise.all([
                    renderNavbar(),
                    renderFooter(),
                ]);
                document.getElementById("navbar").innerHTML = navbarHTML;
                document.getElementById("footer").innerHTML = footerHTML;

                // Cek autentikasi
                const token = sessionStorage.getItem("token");
                if (!token) {
                    window.location.href = "../pages/login.html";
                    return;
                }

                // Ambil data user
                const userResponse = await fetch(`${BASE_URL}/api/user/me`, {
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                if (!userResponse.ok) {
                    throw new Error(`HTTP error! status: ${userResponse.status}`);
                }

                const userResult = await userResponse.json();
                if (userResult.status !== "success" || !userResult.data) {
                    throw new Error("Gagal memuat data user");
                }

                const user = userResult.data;

                // Tampilkan info user di sidebar
                document.getElementById("userName").textContent = user.fullName || user.userName;
                document.getElementById("userRole").textContent = user.role?.name || (user.roleId === 1 ? "Admin" : "Jurnalis");

                // Tampilkan gambar profil
                const profileAvatar = document.getElementById("profileAvatar");
                if (user.profilePict) {
                    profileAvatar.src = user.profilePict;
                    profileAvatar.alt = "Profile Picture";
                    profileAvatar.style.display = "block";

                    // Fallback jika gambar gagal dimuat
                    profileAvatar.onerror = function () {
                        this.style.display = "none";
                        const avatarContainer = document.querySelector(".avatar");
                        avatarContainer.innerHTML = user.fullName
                            ? user.fullName.charAt(0).toUpperCase()
                            : '<i class="fas fa-user"></i>';
                        avatarContainer.style.display = "flex";
                        avatarContainer.style.alignItems = "center";
                        avatarContainer.style.justifyContent = "center";
                        avatarContainer.style.fontSize = "2rem";
                        avatarContainer.style.backgroundColor = "#444";
                        avatarContainer.style.color = "#fff";
                    };
                } else {
                    // Jika tidak ada gambar profil, tampilkan inisial
                    const avatarContainer = document.querySelector(".avatar");
                    avatarContainer.innerHTML = user.fullName
                        ? user.fullName.charAt(0).toUpperCase()
                        : '<i class="fas fa-user"></i>';
                    avatarContainer.style.display = "flex";
                    avatarContainer.style.alignItems = "center";
                    avatarContainer.style.justifyContent = "center";
                    avatarContainer.style.fontSize = "2rem";
                    avatarContainer.style.backgroundColor = "#444";
                    avatarContainer.style.color = "#fff";
                }

                // Generate sidebar menu
                const sideMenu = document.querySelector(".side-menu");
                const roleId = user.roleId || (user.role && user.role.id);
                sideMenu.innerHTML = generateSideMenu(roleId);

                // Jika admin / jurnalis, load data dashboard
                if (roleId === 1 || roleId === 2) {
                    await loadDashboardData(user);
                } else {
                    window.location.href = "auth_newslist.html";
                }


            } catch (error) {
                console.error("Error:", error);
                // Fallback ke data dari token jika endpoint /me gagal
                const token = sessionStorage.getItem("token");
                if (token) {
                    const decodedUser = decodeToken(token);
                    if (decodedUser) {
                        document.getElementById("userName").textContent = decodedUser.fullName || decodedUser.userName;
                        document.getElementById("userRole").textContent = decodedUser.roleId === 1 ? "Admin" : "Jurnalis";

                        // Generate sidebar menu
                        const sideMenu = document.querySelector(".side-menu");
                        sideMenu.innerHTML = generateSideMenu(decodedUser.roleId);

                        if (decodedUser.roleId === 1) {
                            await loadDashboardData();
                        } else {
                            window.location.href = "auth_newslist.html";
                        }
                    }
                } else {
                    window.location.href = "../pages/login.html";
                }
            }
        });
    </script>
</body>

</html>